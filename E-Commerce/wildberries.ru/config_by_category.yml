#wildberriesru digger
---
config:
    debug: 2
    agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/84.0.4147.89 Safari/537.36
    keepalive: disable
do:
- counter_reset: pool
- variable_set: 
    field: repc
    value: "yes"
- walk:
    to: links
    repeat_in_pool: <%repc%>
    do:
    - variable_clear: repc
    - counter_increment:
        name: pool
    - find: 
        path: body 
        do: 
        - static_get: responseCode
        - if:
            match: 503|423|404
            do:
            - proxy_switch
            - cookie_reset
            - variable_set: 
                field: repc
                value: "yes"
            - counter_get: pool
            - if:
                gt: 5
                type: int
                do:
                - error: Server return 503 error code after 5 retries, exiting
                - exit
            - info: Server return 503 error code, retrying
            else:
            - counter_reset: pool
    - proxy_switch
    - cookie_reset
    - variable_clear: pagination
    - counter_reset: products 
    - variable_clear: subject
    - find: 
        path: body 
        do: 
        - static_get: url
        - filter:
            args:
                - xsubject\=(\d+)
        - if:
            match: \d
            do:
            - variable_set: subject
    - find: 
        path: a.pagination-next,.catalog-pagination__next, a.pagination__next
        do: 
        - variable_set: 
            field: pagination
            value: 1
        - parse:
            attr: href
            filter: 
                - (^.+)?xsubject=\d+(.+)
                - (^.+)xsubject
                - (^.+)
        - normalize:
            routine: replace_substring
            args:
                - \?\?: '?'
        - if:
            match: \S
            do:
            - if:
                match: page=
                do:
                - normalize:
                    routine: url
                - register_set: <%register%>&xsubject=<%subject%>
                - link_add
    - find: 
        path: .j-card-item
        do: 
        - variable_clear: sku
        
        - counter_increment:
            name: items
        - find: 
            path: .j-open-full-product-card
            slice: 0
            do: 
            - parse:
                attr: href
                filter:
                    - (^[^\?]+)
            - if:
                match: \S
                do:
                - normalize:
                    routine: url
                - object_new: item
                - find: 
                    path: .product-card__img-wrap > img 
                    do: 
                    - parse:
                        attr: src
                    - if:
                        match: \S
                        do:
                        - normalize:
                            routine: url
                        - object_field_set:
                            object: item
                            field: image
                - object_field_set:
                    object: item
                    field: url 
                - filter:
                    args:
                        - catalog\/(\d+)\/
                - if:
                    match: \d
                    do:
                    - variable_set: sku
                    - object_field_set:
                        object: item
                        field: sku
                    - variable_set: 
                        field: rep
                        value: "yes"
                    - counter_reset: sellerReq 
                    - walk:
                        to: https://wbx-content-v2.wbstatic.net/sellers/<%sku%>.json
                        repeat: <%rep%>
                        do:
                        - variable_clear: rep
                        - counter_increment:
                            name: sellerReq
                        - find: 
                            path: body 
                            do: 
                            - static_get: responseCode
                            - if:
                                match: 503|423|404
                                do:
                                - proxy_switch
                                - cookie_reset
                                - variable_set: 
                                    field: repc
                                    value: "yes"
                                - counter_get: sellerReq
                                - if:
                                    gt: 5
                                    type: int
                                    do:
                                    - error: Server return 503 error code after 5 retries, skipping
                                - info: Server return 503 error code, retrying
                                else:
                                - counter_reset: sellerReq
                        - find: 
                            path: supplierName 
                            do: 
                            - parse
                            - space_dedupe
                            - trim
                            - if:
                                match: \S
                                do:
                                - object_field_set:
                                    object: item
                                    field: seller
                    - variable_set: 
                        field: rep
                        value: "yes"
                    - counter_reset: infoReq 
                    - walk:
                        to: https://wbx-content-v2.wbstatic.net/ru/<%sku%>.json
                        repeat: <%rep%>
                        do:
                        - variable_clear: rep
                        - counter_increment:
                            name: infoReq
                        - find: 
                            path: body 
                            do: 
                            - static_get: responseCode
                            - if:
                                match: 503|423|404
                                do:
                                - proxy_switch
                                - cookie_reset
                                - variable_set: 
                                    field: repc
                                    value: "yes"
                                - counter_get: infoReq
                                - if:
                                    gt: 5
                                    type: int
                                    do:
                                    - error: Server return 503 error code after 5 retries, skipping
                                - info: Server return 503 error code, retrying
                                else:
                                - counter_reset: infoReq
                        - find: 
                            path: selling > brand_name 
                            do: 
                            - parse
                            - space_dedupe
                            - trim
                            - if:
                                match: \S
                                do:
                                - object_field_set:
                                    object: item
                                    field: brand
                        - find: 
                            path: kinds 
                            do: 
                            - parse
                            - space_dedupe
                            - trim
                            - if:
                                match: \S
                                do:
                                - object_field_set:
                                    object: item
                                    field: gender
                        - find: 
                            path: nm_colors_names 
                            do: 
                            - parse
                            - space_dedupe
                            - trim
                            - if:
                                match: \S
                                do:
                                - object_field_set:
                                    object: item
                                    field: color
                        - find: 
                            path: description 
                            do: 
                            - parse
                            - space_dedupe
                            - trim
                            - if:
                                match: \S
                                do:
                                - object_field_set:
                                    object: item
                                    field: description
                        - find: 
                            path: subj_name, subj_root_name 
                            do: 
                            - parse
                            - space_dedupe
                            - trim
                            - object_field_set:
                                object: item
                                field: categories
                                joinby: ","
                        - find: 
                            path: imt_name
                            do: 
                            - parse
                            - space_dedupe
                            - trim
                            - object_field_set:
                                object: item
                                field: title
                - find: 
                    path: .dtList-comments-count,.product-card__count
                    do: 
                    - parse
                    - space_dedupe
                    - trim
                    - if:
                        match: \d
                        do:
                        - object_field_set:
                            object: item
                            field: total_reviews
                - find: 
                    path: .product-card__rating
                    do: 
                    - parse:
                        attr: class
                    - register_set: <p><%register%></p>
                    - to_block
                    - find: 
                        path: p 
                        do: 
                        - split:
                            context: text
                            delimiter: " "
                        - find: 
                            path: .splitted 
                            do: 
                            - parse
                            - if:
                                match: ^star
                                do:
                                - filter:
                                    args:
                                        - star(\d+)
                                - if:
                                    match: \d
                                    do:
                                    - object_field_set:
                                        object: item
                                        field: rating
                - register_set: "yes"
                - object_field_set:
                    object: item
                    field: instock
                - find: 
                    path: .price > .lower-price 
                    do: 
                    - parse
                    - space_dedupe
                    - trim
                    - if:
                        match: \S
                        do:
                        - normalize:
                            routine: replace_substring
                            args:
                                - \s*₽: ''
                        - if:
                            match: \d
                            do:
                            - object_field_set:
                                object: item
                                field: price
                - object_save:
                    name: item
